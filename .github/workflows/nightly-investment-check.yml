name: ðŸ¦… Canari V2.0 - Anti-Code Rot

on:
  schedule:
    # ExÃ©cution toutes les nuits Ã  3h00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:  # Permet l'exÃ©cution manuelle

jobs:
  # Job baseline : Tests V1.6 (ENABLE_INVESTMENT_FEATURES=False)
  test-v1-baseline:
    runs-on: ubuntu-latest
    name: ðŸ§ª Tests V1.6 (Baseline)
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: egotest
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: ðŸ“¦ Install Backend Dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: ðŸ—„ï¸ Run Migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/egotest
          DJANGO_SECRET_KEY: test-secret-key-for-ci-testing-only-min-50-chars-required
          DEBUG: '1'
          ENABLE_SAKA: 'True'
          SAKA_COMPOST_ENABLED: 'True'
          SAKA_SILO_REDIS_ENABLED: 'True'
        run: |
          cd backend
          python manage.py migrate
      
      - name: ðŸ§ª Run Backend Tests (V1.6)
        id: backend_tests_v1
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/egotest
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SECRET_KEY: test-secret-key-for-ci-testing-only-min-50-chars-required
          DEBUG: '1'
          DISABLE_THROTTLE_FOR_TESTS: '1'
          # V1.6 : Investment features dÃ©sactivÃ©es
          ENABLE_INVESTMENT_FEATURES: 'False'
          EGOEJO_COMMISSION_RATE: '0.05'
          STRIPE_FEE_ESTIMATE: '0.03'
          FOUNDER_GROUP_NAME: 'Founders_V1_Protection'
          ENABLE_SAKA: 'True'
          SAKA_COMPOST_ENABLED: 'True'
          SAKA_SILO_REDIS_ENABLED: 'True'
        run: |
          cd backend
          pytest -v --tb=short --junitxml=test-results-v1.xml || true
          pytest -v --tb=short > test-output-v1.txt 2>&1 || true
        continue-on-error: true
      
      - name: ðŸ“Š Parse Test Results (V1.6)
        id: parse_v1
        run: |
          if [ -f backend/test-results-v1.xml ]; then
            # Extraire le nombre de tests et Ã©checs
            TOTAL=$(grep -o 'tests="[0-9]*"' backend/test-results-v1.xml | grep -o '[0-9]*' | head -1 || echo "0")
            FAILED=$(grep -o 'failures="[0-9]*"' backend/test-results-v1.xml | grep -o '[0-9]*' | head -1 || echo "0")
            ERRORED=$(grep -o 'errors="[0-9]*"' backend/test-results-v1.xml | grep -o '[0-9]*' | head -1 || echo "0")
            
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "errored=$ERRORED" >> $GITHUB_OUTPUT
            
            if [ "$FAILED" -eq 0 ] && [ "$ERRORED" -eq 0 ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "âœ… V1.6 Baseline: $TOTAL tests, 0 Ã©checs"
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              echo "âŒ V1.6 Baseline: $TOTAL tests, $FAILED Ã©checs, $ERRORED erreurs"
            fi
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "errored=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ Fichier de rÃ©sultats introuvable"
          fi
      
      - name: ðŸ’¾ Upload Test Results (V1.6)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-v1-baseline
          path: |
            backend/test-results-v1.xml
            backend/test-output-v1.txt
          retention-days: 7
      
      - name: ðŸ“ Frontend Tests (V1.6)
        id: frontend_tests_v1
        run: |
          cd frontend/frontend
          
          # Setup Node.js
          if ! command -v node &> /dev/null; then
            echo "Node.js non trouvÃ©, installation..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # Install dependencies
          npm ci || npm install
          
          # Run tests
          npm test -- --run > test-output-v1.txt 2>&1 || true
          
          # Parse results
          if grep -q "Tests:" test-output-v1.txt; then
            echo "âœ… Frontend tests V1.6 exÃ©cutÃ©s"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Frontend tests V1.6 non exÃ©cutÃ©s ou erreur"
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

  # Job canari : Tests V2.0 (ENABLE_INVESTMENT_FEATURES=True)
  test-v2-canary:
    runs-on: ubuntu-latest
    name: ðŸ¦… Tests V2.0 (Canari)
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: egotest
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: ðŸ“¦ Install Backend Dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: ðŸ—„ï¸ Run Migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/egotest
          DJANGO_SECRET_KEY: test-secret-key-for-ci-testing-only-min-50-chars-required
          DEBUG: '1'
          ENABLE_SAKA: 'True'
          SAKA_COMPOST_ENABLED: 'True'
          SAKA_SILO_REDIS_ENABLED: 'True'
        run: |
          cd backend
          python manage.py migrate
      
      - name: ðŸ¦… Run Backend Tests (V2.0 - Canari)
        id: backend_tests_v2
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/egotest
          REDIS_URL: redis://localhost:6379/0
          DJANGO_SECRET_KEY: test-secret-key-for-ci-testing-only-min-50-chars-required
          DEBUG: '1'
          DISABLE_THROTTLE_FOR_TESTS: '1'
          # V2.0 : Investment features ACTIVÃ‰ES (canari)
          ENABLE_INVESTMENT_FEATURES: 'True'
          EGOEJO_COMMISSION_RATE: '0.05'
          STRIPE_FEE_ESTIMATE: '0.03'
          FOUNDER_GROUP_NAME: 'Founders_V1_Protection'
          ENABLE_SAKA: 'True'
          SAKA_COMPOST_ENABLED: 'True'
          SAKA_SILO_REDIS_ENABLED: 'True'
        run: |
          cd backend
          echo "ðŸ¦… CANARI V2.0 : Tests avec ENABLE_INVESTMENT_FEATURES=True"
          echo "=========================================================="
          pytest -v --tb=short --junitxml=test-results-v2.xml || true
          pytest -v --tb=short > test-output-v2.txt 2>&1 || true
        continue-on-error: true
      
      - name: ðŸ“Š Parse Test Results (V2.0)
        id: parse_v2
        run: |
          if [ -f backend/test-results-v2.xml ]; then
            # Extraire le nombre de tests et Ã©checs
            TOTAL=$(grep -o 'tests="[0-9]*"' backend/test-results-v2.xml | grep -o '[0-9]*' | head -1 || echo "0")
            FAILED=$(grep -o 'failures="[0-9]*"' backend/test-results-v2.xml | grep -o '[0-9]*' | head -1 || echo "0")
            ERRORED=$(grep -o 'errors="[0-9]*"' backend/test-results-v2.xml | grep -o '[0-9]*' | head -1 || echo "0")
            
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "errored=$ERRORED" >> $GITHUB_OUTPUT
            
            if [ "$FAILED" -eq 0 ] && [ "$ERRORED" -eq 0 ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "âœ… V2.0 Canari: $TOTAL tests, 0 Ã©checs"
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              echo "âŒ V2.0 Canari: $TOTAL tests, $FAILED Ã©checs, $ERRORED erreurs"
            fi
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "errored=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ Fichier de rÃ©sultats introuvable"
          fi
      
      - name: ðŸ’¾ Upload Test Results (V2.0)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-v2-canary
          path: |
            backend/test-results-v2.xml
            backend/test-output-v2.txt
          retention-days: 7
      
      - name: ðŸ“ Frontend Tests (V2.0)
        id: frontend_tests_v2
        run: |
          cd frontend/frontend
          
          # Setup Node.js
          if ! command -v node &> /dev/null; then
            echo "Node.js non trouvÃ©, installation..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # Install dependencies
          npm ci || npm install
          
          # Run tests
          npm test -- --run > test-output-v2.txt 2>&1 || true
          
          # Parse results
          if grep -q "Tests:" test-output-v2.txt; then
            echo "âœ… Frontend tests V2.0 exÃ©cutÃ©s"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Frontend tests V2.0 non exÃ©cutÃ©s ou erreur"
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

  # Job d'analyse et d'alerte
  analyze-and-alert:
    runs-on: ubuntu-latest
    name: ðŸ” Analyse & Alerte Code Rot
    needs: [test-v1-baseline, test-v2-canary]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ’¾ Download Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: test-results/
      
      - name: ðŸ” Analyse RÃ©sultats
        id: analyze
        run: |
          echo "ðŸ” Analyse des rÃ©sultats Canari V2.0"
          echo "===================================="
          
          # Lire les rÃ©sultats V1.6
          V1_STATUS="${{ needs.test-v1-baseline.outputs.parse_v1.status }}"
          V1_FAILED="${{ needs.test-v1-baseline.outputs.parse_v1.failed }}"
          V1_TOTAL="${{ needs.test-v1-baseline.outputs.parse_v1.total }}"
          
          # Lire les rÃ©sultats V2.0
          V2_STATUS="${{ needs.test-v2-canary.outputs.parse_v2.status }}"
          V2_FAILED="${{ needs.test-v2-canary.outputs.parse_v2.failed }}"
          V2_TOTAL="${{ needs.test-v2-canary.outputs.parse_v2.total }}"
          
          echo "V1.6 Baseline: Status=$V1_STATUS, Failed=$V1_FAILED, Total=$V1_TOTAL"
          echo "V2.0 Canari: Status=$V2_STATUS, Failed=$V2_FAILED, Total=$V2_TOTAL"
          
          # DÃ©tecter Code Rot : V2.0 Ã©choue alors que V1.6 passe
          CODE_ROT_DETECTED=false
          
          if [ "$V1_STATUS" = "success" ] && [ "$V2_STATUS" != "success" ]; then
            CODE_ROT_DETECTED=true
            echo "ðŸš¨ CODE ROT DÃ‰TECTÃ‰ : V2.0 Ã©choue alors que V1.6 passe"
            echo "code_rot_detected=true" >> $GITHUB_OUTPUT
          elif [ "$V1_FAILED" -eq 0 ] && [ "$V2_FAILED" -gt 0 ]; then
            CODE_ROT_DETECTED=true
            echo "ðŸš¨ CODE ROT DÃ‰TECTÃ‰ : V2.0 a $V2_FAILED Ã©chec(s) alors que V1.6 passe"
            echo "code_rot_detected=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Pas de Code Rot dÃ©tectÃ©"
            echo "code_rot_detected=false" >> $GITHUB_OUTPUT
          fi
          
          # PrÃ©parer le message d'alerte
          if [ "$CODE_ROT_DETECTED" = "true" ]; then
            echo "alert_message=ðŸš¨ CODE ROT V2.0 DÃ‰TECTÃ‰" >> $GITHUB_OUTPUT
            echo "alert_body=Le code V2.0 (dormant) casse alors que V1.6 fonctionne correctement." >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ“ CrÃ©er Issue GitHub (si Code Rot dÃ©tectÃ©)
        if: steps.analyze.outputs.code_rot_detected == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = `ðŸ¦… [Canari V2.0] Code Rot DÃ©tectÃ© - ${new Date().toISOString().split('T')[0]}`;
            
            const body = `## ðŸš¨ Alerte Code Rot V2.0
            
            Le **Canari V2.0** a dÃ©tectÃ© une dÃ©gradation du code dormant (Investment Features).
            
            ### ðŸ“Š RÃ©sultats
            
            **V1.6 Baseline** (ENABLE_INVESTMENT_FEATURES=False):
            - Status: ${{ needs.test-v1-baseline.outputs.parse_v1.status }}
            - Tests: ${{ needs.test-v1-baseline.outputs.parse_v1.total }}
            - Ã‰checs: ${{ needs.test-v1-baseline.outputs.parse_v1.failed }}
            
            **V2.0 Canari** (ENABLE_INVESTMENT_FEATURES=True):
            - Status: ${{ needs.test-v2-canary.outputs.parse_v2.status }}
            - Tests: ${{ needs.test-v2-canary.outputs.parse_v2.total }}
            - Ã‰checs: ${{ needs.test-v2-canary.outputs.parse_v2.failed }}
            
            ### ðŸ” Analyse
            
            Le code V2.0 (dormant) Ã©choue alors que V1.6 fonctionne correctement. Cela indique que :
            - Le code V2.0 a Ã©tÃ© cassÃ© par des modifications V1.6
            - Des dÃ©pendances ont Ã©tÃ© modifiÃ©es sans mise Ã  jour V2.0
            - Des migrations ou changements de modÃ¨les ont impactÃ© V2.0
            
            ### âœ… Actions Requises
            
            1. **VÃ©rifier les logs de tests** : Consulter les artifacts uploadÃ©s
            2. **Identifier les tests en Ã©chec** : Analyser les diffÃ©rences V1.6 vs V2.0
            3. **Corriger le code V2.0** : Maintenir la compatibilitÃ© du code dormant
            4. **VÃ©rifier la correction** : Relancer le workflow manuellement
            
            ### ðŸ“š Documentation
            
            - [Architecture Sleeping Giant](docs/architecture/ARCHITECTURE_SLEEPING_GIANT_V1.6_V2.0.md)
            - [Guide Dormance V2.0](docs/production/GUIDE_V2_DORMANCY.md)
            
            ### ðŸ”— Workflow
            
            Workflow: [Nightly Investment Check](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            
            *Cette issue a Ã©tÃ© crÃ©Ã©e automatiquement par le Canari V2.0 (Anti-Code Rot)*
            `;
            
            // VÃ©rifier si une issue similaire existe dÃ©jÃ  (Ã©viter les doublons)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'canari-v2.0,code-rot'
            });
            
            // Si une issue ouverte existe dÃ©jÃ , la mettre Ã  jour
            if (existingIssues.data.length > 0) {
              const existingIssue = existingIssues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ”„ Mise Ã  jour - ${new Date().toISOString()}
                
                Le Code Rot persiste. Nouvelle exÃ©cution du Canari :
                
                **V2.0 Canari**:
                - Tests: ${{ needs.test-v2-canary.outputs.parse_v2.total }}
                - Ã‰checs: ${{ needs.test-v2-canary.outputs.parse_v2.failed }}
                
                [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                `
              });
              console.log(`âœ… Issue existante mise Ã  jour: #${existingIssue.number}`);
            } else {
              // CrÃ©er une nouvelle issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['canari-v2.0', 'code-rot', 'bug', 'v2.0-dormant']
              });
              console.log(`âœ… Issue crÃ©Ã©e: #${issue.data.number}`);
            }
      
      - name: ðŸ“Š RÃ©sumÃ© Canari
        if: always()
        run: |
          echo "## ðŸ¦… RÃ©sumÃ© Canari V2.0 - Anti-Code Rot" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š RÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**V1.6 Baseline** (ENABLE_INVESTMENT_FEATURES=False):" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.test-v1-baseline.outputs.parse_v1.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test-v1-baseline.outputs.parse_v1.total }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ã‰checs: ${{ needs.test-v1-baseline.outputs.parse_v1.failed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**V2.0 Canari** (ENABLE_INVESTMENT_FEATURES=True):" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.test-v2-canary.outputs.parse_v2.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test-v2-canary.outputs.parse_v2.total }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ã‰checs: ${{ needs.test-v2-canary.outputs.parse_v2.failed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.analyze.outputs.code_rot_detected }}" = "true" ]; then
            echo "### ðŸš¨ CODE ROT DÃ‰TECTÃ‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Le code V2.0 (dormant) casse alors que V1.6 fonctionne correctement." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action requise** : Une issue GitHub a Ã©tÃ© crÃ©Ã©e automatiquement." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Pas de Code Rot" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Le code V2.0 (dormant) reste sain. Aucune action requise." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Canari V2.0 - Anti-Code Rot Pipeline*" >> $GITHUB_STEP_SUMMARY

