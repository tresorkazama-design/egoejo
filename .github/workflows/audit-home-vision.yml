name: ğŸ›¡ï¸ Audit BLOQUANT - Home/Vision

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  audit-home-vision:
    name: Audit BLOQUANT Home/Vision
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/frontend/package-lock.json
      
      - name: ğŸ“¥ Install dependencies
        working-directory: frontend/frontend
        run: npm ci
      
      - name: ğŸ” Run ESLint
        id: lint
        working-directory: frontend/frontend
        run: npm run lint
        continue-on-error: false
      
      - name: ğŸ§ª Run unit tests
        id: unit-tests
        working-directory: frontend/frontend
        run: npm run test:run
        continue-on-error: false
      
      - name: ğŸ›¡ï¸ Run audit:home-vision
        id: audit
        working-directory: frontend/frontend
        run: npm run audit:home-vision
        continue-on-error: false
      
      - name: ğŸ­ Install Playwright browsers
        working-directory: frontend/frontend
        run: npx playwright install --with-deps chromium
      
      - name: ğŸ­ Run E2E tests (home-vision-compliance)
        id: e2e-tests
        working-directory: frontend/frontend
        run: npm run test:e2e -- e2e/home-vision-compliance.spec.js
        continue-on-error: false
        env:
          CI: true
          E2E_MODE: mock-only
      
      - name: ğŸ“Š Generate summary
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ“Š RÃ‰SUMÃ‰ AUDIT HOME/VISION"
          echo "=========================================="
          echo ""
          
          # Lint
          if [ "${{ steps.lint.outcome }}" == "success" ]; then
            echo "âœ… Lint: OK"
          else
            echo "âŒ Lint: Ã‰CHEC"
          fi
          
          # Unit tests
          if [ "${{ steps.unit-tests.outcome }}" == "success" ]; then
            echo "âœ… Unit tests: OK"
          else
            echo "âŒ Unit tests: Ã‰CHEC"
          fi
          
          # Audit
          if [ "${{ steps.audit.outcome }}" == "success" ]; then
            echo "âœ… Audit: OK"
          else
            echo "âŒ Audit: Ã‰CHEC"
          fi
          
          # E2E tests
          if [ "${{ steps.e2e-tests.outcome }}" == "success" ]; then
            echo "âœ… E2E tests: OK"
          else
            echo "âŒ E2E tests: Ã‰CHEC"
          fi
          
          echo ""
          echo "=========================================="
          
          # Ã‰chouer si une Ã©tape a Ã©chouÃ©
          if [ "${{ steps.lint.outcome }}" != "success" ] || \
             [ "${{ steps.unit-tests.outcome }}" != "success" ] || \
             [ "${{ steps.audit.outcome }}" != "success" ] || \
             [ "${{ steps.e2e-tests.outcome }}" != "success" ]; then
            echo ""
            echo "âŒ Ã‰CHEC : Au moins une Ã©tape a Ã©chouÃ©."
            exit 1
          else
            echo ""
            echo "âœ… SUCCÃˆS : Toutes les Ã©tapes sont passÃ©es."
          fi
      
      - name: ğŸ“¤ Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-home-vision-compliance
          path: frontend/frontend/playwright-report/
          retention-days: 7
          if-no-files-found: ignore
