name: ðŸ›ï¸ EGOEJO Guardian - CI de ConformitÃ© Constitutionnelle

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  push:
    branches: [main, develop]

jobs:
  egoejo-conformity:
    runs-on: ubuntu-latest
    name: ðŸ›¡ï¸ VÃ©rification ConformitÃ© Constitution EGOEJO
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour git diff complet
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ” Scan Guardian - Analyse Git Diff
        id: guardian_scan
        run: |
          echo "ðŸ›ï¸ EGOEJO Guardian - Analyse de conformitÃ©"
          echo "=========================================="
          
          # DÃ©terminer la branche de base
          if [ -n "${{ github.base_ref }}" ]; then
            BASE_BRANCH="origin/${{ github.base_ref }}"
          else
            BASE_BRANCH="origin/main"
          fi
          
          echo "Branche de base: $BASE_BRANCH"
          
          # ExÃ©cuter le script Guardian
          python .egoejo/guardian.py "$BASE_BRANCH"
          
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Guardian Scan: PASS"
            echo "guardian_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Guardian Scan: FAIL"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Le Guardian a dÃ©tectÃ© des violations critiques"
            echo "guardian_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸ”’ Scan SÃ©paration SAKA/EUR - VÃ©rification Ã‰tanchÃ©itÃ©
        id: separation_scan
        run: |
          echo "ðŸ”’ VÃ©rification Ã‰tanchÃ©itÃ© SAKA â†” EUR"
          echo "===================================="
          
          # DÃ©terminer la branche de base
          if [ -n "${{ github.base_ref }}" ]; then
            BASE_BRANCH="origin/${{ github.base_ref }}"
          else
            BASE_BRANCH="origin/main"
          fi
          
          # RÃ©cupÃ©rer les fichiers modifiÃ©s
          MODIFIED_FILES=$(git diff --name-only "$BASE_BRANCH" | grep -E '\.(py|js|jsx|ts|tsx)$' || true)
          
          if [ -z "$MODIFIED_FILES" ]; then
            echo "âœ… Aucun fichier modifiÃ© Ã  vÃ©rifier"
            echo "separation_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          VIOLATIONS=0
          VIOLATION_FILES=""
          
          # Fichiers admin explicites autorisÃ©s (peuvent contenir les deux pour comparaison/test)
          ADMIN_FILES="admin.py|tests.*compliance.*test_saka_eur_etancheite|tests.*compliance.*test_saka_eur_separation"
          
          echo "Fichiers Ã  vÃ©rifier:"
          echo "$MODIFIED_FILES" | while read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            # Ignorer les fichiers admin explicites
            if echo "$file" | grep -qiE "$ADMIN_FILES"; then
              echo "  [SKIP] $file (fichier admin/test de sÃ©paration autorisÃ©)"
              continue
            fi
            
            # VÃ©rifier si le fichier contient Ã  la fois UserWallet et SakaWallet
            if [ -f "$file" ]; then
              if grep -qi "UserWallet" "$file" && grep -qi "SakaWallet" "$file"; then
                # VÃ©rifier que ce n'est pas juste un import ou un commentaire
                # Compter les occurrences rÃ©elles (hors commentaires, hors imports simples)
                USERWALLET_COUNT=$(grep -vE '^\s*#|^\s*//|^\s*\*|from.*import|import.*UserWallet' "$file" | grep -ci "UserWallet" || echo "0")
                SAKAWALLET_COUNT=$(grep -vE '^\s*#|^\s*//|^\s*\*|from.*import|import.*SakaWallet' "$file" | grep -ci "SakaWallet" || echo "0")
                
                if [ "$USERWALLET_COUNT" -gt 0 ] && [ "$SAKAWALLET_COUNT" -gt 0 ]; then
                  echo "âŒ VIOLATION: $file contient Ã  la fois UserWallet et SakaWallet"
                  echo "::error file=$file::ðŸš« VIOLATION CONSTITUTION EGOEJO : Ã‰tanchÃ©itÃ© SAKA/EUR rompue. Un fichier ne peut pas contenir Ã  la fois UserWallet (EUR) et SakaWallet (SAKA), sauf fichiers admin explicites."
                  VIOLATIONS=$((VIOLATIONS + 1))
                  VIOLATION_FILES="$VIOLATION_FILES $file"
                fi
              fi
            fi
          done
          
          # VÃ©rifier aussi dans tous les fichiers du repo (pas seulement modifiÃ©s) pour dÃ©tecter les violations existantes
          echo ""
          echo "Scan complet du codebase pour violations de sÃ©paration..."
          
          ALL_VIOLATIONS=$(find backend frontend -type f \( -name "*.py" -o -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) 2>/dev/null | while read -r file; do
            # Ignorer les fichiers admin explicites
            if echo "$file" | grep -qiE "$ADMIN_FILES"; then
              continue
            fi
            
            # Ignorer node_modules, migrations, etc.
            if echo "$file" | grep -qiE "node_modules|migrations|__pycache__|\.git"; then
              continue
            fi
            
            if [ -f "$file" ]; then
              if grep -qi "UserWallet" "$file" && grep -qi "SakaWallet" "$file"; then
                USERWALLET_COUNT=$(grep -vE '^\s*#|^\s*//|^\s*\*|from.*import|import.*UserWallet' "$file" 2>/dev/null | grep -ci "UserWallet" || echo "0")
                SAKAWALLET_COUNT=$(grep -vE '^\s*#|^\s*//|^\s*\*|from.*import|import.*SakaWallet' "$file" 2>/dev/null | grep -ci "SakaWallet" || echo "0")
                
                if [ "$USERWALLET_COUNT" -gt 0 ] && [ "$SAKAWALLET_COUNT" -gt 0 ]; then
                  echo "$file"
                fi
              fi
            fi
          done)
          
          if [ -n "$ALL_VIOLATIONS" ]; then
            echo "âŒ VIOLATIONS DÃ‰TECTÃ‰ES dans le codebase:"
            echo "$ALL_VIOLATIONS" | while read -r file; do
              echo "  - $file"
              echo "::error file=$file::ðŸš« VIOLATION CONSTITUTION EGOEJO : Ã‰tanchÃ©itÃ© SAKA/EUR rompue"
            done
            VIOLATIONS=$((VIOLATIONS + $(echo "$ALL_VIOLATIONS" | wc -l)))
          fi
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "âœ… SÃ©paration SAKA/EUR: PASS"
            echo "separation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ SÃ©paration SAKA/EUR: FAIL ($VIOLATIONS violation(s))"
            echo "::error::ðŸš« $VIOLATIONS violation(s) de sÃ©paration SAKA/EUR dÃ©tectÃ©e(s)"
            echo "separation_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸ§ª Validation Tests Philosophie SAKA
        id: philosophy_tests
        run: |
          echo "ðŸ§ª ExÃ©cution Tests Philosophie SAKA"
          echo "==================================="
          
          # Installer les dÃ©pendances Python si nÃ©cessaire
          if [ -f "backend/requirements.txt" ]; then
            echo "Installation des dÃ©pendances Python..."
            pip install -q -r backend/requirements.txt
          fi
          
          # VÃ©rifier que le fichier de test existe
          if [ ! -f "backend/core/tests_saka_philosophy.py" ]; then
            echo "âŒ Fichier de test introuvable: backend/core/tests_saka_philosophy.py"
            echo "::error::ðŸš« Fichier de test de philosophie SAKA introuvable"
            echo "philosophy_tests_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # ExÃ©cuter les tests de philosophie SAKA
          cd backend
          
          # Configurer Django settings si nÃ©cessaire
          export DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE:-config.settings}
          
          # ExÃ©cuter pytest avec le fichier de test
          pytest core/tests_saka_philosophy.py -v --tb=short
          
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Tests Philosophie SAKA: PASS"
            echo "philosophy_tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests Philosophie SAKA: FAIL"
            echo "::error::ðŸš« Les tests de philosophie SAKA ont Ã©chouÃ©. La constitution EGOEJO n'est pas respectÃ©e."
            echo "philosophy_tests_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸ“Š RÃ©sumÃ© ConformitÃ© EGOEJO
        if: always()
        run: |
          echo "## ðŸ›ï¸ Rapport de ConformitÃ© Constitution EGOEJO" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… VÃ©rifications EffectuÃ©es :" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ã‰tat du Guardian Scan
          if [ "${{ steps.guardian_scan.outcome }}" == "success" ]; then
            echo "1. âœ… **Guardian Scan** : PASS - Aucune violation dÃ©tectÃ©e" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. âŒ **Guardian Scan** : FAIL - Violations critiques dÃ©tectÃ©es" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Ã‰tat du Scan de SÃ©paration
          if [ "${{ steps.separation_scan.outcome }}" == "success" ]; then
            echo "2. âœ… **SÃ©paration SAKA/EUR** : PASS - Ã‰tanchÃ©itÃ© respectÃ©e" >> $GITHUB_STEP_SUMMARY
          else
            echo "2. âŒ **SÃ©paration SAKA/EUR** : FAIL - Violations de sÃ©paration dÃ©tectÃ©es" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Ã‰tat des Tests de Philosophie
          if [ "${{ steps.philosophy_tests.outcome }}" == "success" ]; then
            echo "3. âœ… **Tests Philosophie SAKA** : PASS - Tous les tests passent" >> $GITHUB_STEP_SUMMARY
          else
            echo "3. âŒ **Tests Philosophie SAKA** : FAIL - Tests Ã©chouÃ©s" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Constitution EGOEJO :" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Structure Relationnelle (SAKA)** : Souveraine, Prioritaire" >> $GITHUB_STEP_SUMMARY
          echo "- **Structure Instrumentale (EUR)** : SubordonnÃ©e, Dormante par dÃ©faut" >> $GITHUB_STEP_SUMMARY
          echo "- **RÃ¨gle Absolue** : Aucune conversion SAKA â†” EUR" >> $GITHUB_STEP_SUMMARY
          echo "- **RÃ¨gle Absolue** : Aucun rendement financier sur SAKA" >> $GITHUB_STEP_SUMMARY
          echo "- **RÃ¨gle Absolue** : Ã‰tanchÃ©itÃ© stricte SAKA/EUR (aucun fichier ne peut contenir les deux)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # DÃ©terminer le statut final
          if [ "${{ steps.guardian_scan.outcome }}" == "success" ] && \
             [ "${{ steps.separation_scan.outcome }}" == "success" ] && \
             [ "${{ steps.philosophy_tests.outcome }}" == "success" ]; then
            echo "### âœ… **STATUT FINAL : COMPATIBLE EGOEJO**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Cette PR respecte la constitution EGOEJO. Le dÃ©ploiement est autorisÃ©." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ **STATUT FINAL : NON COMPATIBLE EGOEJO**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš« **DÃ‰PLOIEMENT INTERDIT** - Cette PR viole la constitution EGOEJO." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les erreurs ci-dessus et corrigez les violations avant de continuer." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“– Documentation : [Constitution EGOEJO](docs/architecture/CONSTITUTION_EGOEJO.md)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸš« Bloquer DÃ©ploiement si Non Conforme
        if: failure()
        run: |
          echo "::error::ðŸ”´ NON COMPATIBLE EGOEJO"
          echo "::error::ðŸš« DÃ‰PLOIEMENT INTERDIT - Violations de la Constitution EGOEJO dÃ©tectÃ©es"
          echo "::error::Consultez docs/architecture/CONSTITUTION_EGOEJO.md pour plus d'informations"
          echo ""
          echo "Les Ã©tapes suivantes ont Ã©chouÃ© :"
          echo "  - Guardian Scan: ${{ steps.guardian_scan.outcome }}"
          echo "  - SÃ©paration SAKA/EUR: ${{ steps.separation_scan.outcome }}"
          echo "  - Tests Philosophie SAKA: ${{ steps.philosophy_tests.outcome }}"
          exit 1
