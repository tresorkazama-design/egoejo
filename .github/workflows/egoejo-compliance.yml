name: ðŸ›¡ï¸ EGOEJO Compliance Philosophique

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Permet l'exÃ©cution manuelle

jobs:
  egoejo-compliance:
    name: Tests de Compliance Philosophique SAKA/EUR
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout augmentÃ© pour tous les scans
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: egotest_compliance
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: ðŸ“¦ Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ—„ï¸ Run database migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/egotest_compliance
          SECRET_KEY: test-secret-key-for-ci-compliance-testing-min-50-chars-required-egoejo
          ENABLE_SAKA: 'True'
          SAKA_COMPOST_ENABLED: 'True'
          SAKA_SILO_REDIS_ENABLED: 'True'
        run: |
          cd backend
          python manage.py migrate --noinput
      
      - name: ðŸ›¡ï¸ Run Compliance Tests (BLOQUANT)
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/egotest_compliance
          SECRET_KEY: test-secret-key-for-ci-compliance-testing-min-50-chars-required-egoejo
          ENABLE_SAKA: 'True'
          SAKA_COMPOST_ENABLED: 'True'
          SAKA_SILO_REDIS_ENABLED: 'True'
          REDIS_URL: redis://localhost:6379/0
        run: |
          cd backend
          echo "ðŸ›¡ï¸ ExÃ©cution des tests de compliance philosophique EGOEJO..."
          echo "ðŸ“‹ Tests protÃ©gÃ©s par le tag @egoejo_compliance"
          echo ""
          
          # ExÃ©cuter UNIQUEMENT les tests marquÃ©s @egoejo_compliance
          # Inclut automatiquement les tests de compliance Ã©ditoriale du contenu
          # Si un seul test Ã©choue, le workflow Ã©choue (BLOQUANT)
          pytest -m egoejo_compliance -v --tb=short --strict-markers
          
          if [ $? -ne 0 ]; then
            echo ""
            echo "âŒ =========================================="
            echo "âŒ VIOLATION CONSTITUTION EGOEJO DÃ‰TECTÃ‰E"
            echo "âŒ =========================================="
            echo ""
            echo "Les tests de compliance (incluant compliance Ã©ditoriale) ont Ã©chouÃ©."
            echo "Ce commit viole la sÃ©paration stricte SAKA/EUR, la philosophie EGOEJO,"
            echo "ou la Constitution Ã©ditoriale du contenu."
            echo ""
            echo "Action requise :"
            echo "1. Corriger le code pour respecter la sÃ©paration SAKA/EUR"
            echo "2. VÃ©rifier la compliance Ã©ditoriale des contenus publiÃ©s"
            echo "3. Relancer les tests : pytest -m egoejo_compliance -v"
            echo "4. Recommiter"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "âœ… =========================================="
          echo "âœ… ConformitÃ© philosophique et Ã©ditoriale validÃ©e"
          echo "âœ… =========================================="
          echo ""
          
          if [ $? -ne 0 ]; then
            echo ""
            echo "âŒ =========================================="
            echo "âŒ VIOLATION CONSTITUTION EGOEJO DÃ‰TECTÃ‰E"
            echo "âŒ =========================================="
            echo ""
            echo "Les tests de compliance philosophique ont Ã©chouÃ©."
            echo "Ce commit viole la sÃ©paration stricte SAKA/EUR ou la philosophie EGOEJO."
            echo ""
            echo "Action requise :"
            echo "1. Corriger le code pour respecter la sÃ©paration SAKA/EUR"
            echo "2. Relancer les tests : pytest -m egoejo_compliance -v"
            echo "3. Recommiter"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "âœ… =========================================="
          echo "âœ… ConformitÃ© philosophique validÃ©e"
          echo "âœ… =========================================="
          echo ""
      
      - name: ðŸ” Scan Automatique du Code Python
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/egotest_compliance
          SECRET_KEY: test-secret-key-for-ci-compliance-testing-min-50-chars-required-egoejo
          ENABLE_SAKA: 'True'
          SAKA_COMPOST_ENABLED: 'True'
          SAKA_SILO_REDIS_ENABLED: 'True'
          REDIS_URL: redis://localhost:6379/0
        run: |
          cd backend
          echo "ðŸ” =========================================="
          echo "ðŸ” SCAN AUTOMATIQUE DU CODE PYTHON"
          echo "ðŸ” =========================================="
          echo ""
          echo "ðŸ“‹ Objectif : DÃ©tecter les violations SAKA/EUR dans le code Python"
          echo "ðŸ“‹ MÃ©thode : Scan rÃ©cursif de tous les fichiers .py"
          echo ""
          
          # ExÃ©cuter le test de scan rÃ©cursif
          pytest tests/compliance/test_no_saka_eur_conversion.py::TestNoSakaEurConversion::test_scan_recursif_tous_fichiers_python_backend -v --tb=short
          
          SCAN_EXIT_CODE=$?
          
          if [ $SCAN_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ =========================================="
            echo "âŒ VIOLATION DÃ‰TECTÃ‰E DANS LE CODE PYTHON"
            echo "âŒ =========================================="
            echo ""
            echo "Le scan rÃ©cursif a dÃ©tectÃ© des patterns interdits :"
            echo "- Conversion SAKA â†” EUR"
            echo "- Accumulation financiÃ¨re"
            echo "- Affichage monÃ©taire"
            echo ""
            echo "Action requise :"
            echo "1. Examiner le rapport du test pour identifier les violations"
            echo "2. Corriger le code pour respecter la sÃ©paration SAKA/EUR"
            echo "3. Relancer le scan : pytest tests/compliance/test_no_saka_eur_conversion.py::TestNoSakaEurConversion::test_scan_recursif_tous_fichiers_python_backend -v"
            echo "4. Recommiter"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "âœ… Scan du code Python : Aucune violation dÃ©tectÃ©e"
          echo ""
      
      - name: ðŸŒ Scan des Endpoints API
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/egotest_compliance
          SECRET_KEY: test-secret-key-for-ci-compliance-testing-min-50-chars-required-egoejo
          ENABLE_SAKA: 'True'
          SAKA_COMPOST_ENABLED: 'True'
          SAKA_SILO_REDIS_ENABLED: 'True'
          REDIS_URL: redis://localhost:6379/0
        run: |
          cd backend
          echo "ðŸŒ =========================================="
          echo "ðŸŒ SCAN DES ENDPOINTS API"
          echo "ðŸŒ =========================================="
          echo ""
          echo "ðŸ“‹ Objectif : VÃ©rifier que les endpoints API respectent la constitution EGOEJO"
          echo "ðŸ“‹ MÃ©thode : Scan automatique de toutes les routes Django"
          echo ""
          
          # ExÃ©cuter le test de scan des endpoints
          pytest tests/compliance/test_api_endpoints_protection.py::TestAPIEndpointsProtection::test_scan_complet_endpoints_et_serializers -v --tb=short
          
          ENDPOINTS_EXIT_CODE=$?
          
          if [ $ENDPOINTS_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ =========================================="
            echo "âŒ VIOLATION DÃ‰TECTÃ‰E DANS LES ENDPOINTS API"
            echo "âŒ =========================================="
            echo ""
            echo "Le scan des endpoints a dÃ©tectÃ© des violations :"
            echo "- Endpoints suggÃ©rant conversion SAKA â†” EUR"
            echo "- Endpoints suggÃ©rant achat/valeur financiÃ¨re"
            echo "- Endpoints suggÃ©rant accumulation"
            echo ""
            echo "Action requise :"
            echo "1. Examiner le rapport du test pour identifier les endpoints violants"
            echo "2. Corriger ou supprimer les endpoints non conformes"
            echo "3. Relancer le scan : pytest tests/compliance/test_api_endpoints_protection.py::TestAPIEndpointsProtection::test_scan_complet_endpoints_et_serializers -v"
            echo "4. Recommiter"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "âœ… Scan des endpoints API : Aucune violation dÃ©tectÃ©e"
          echo ""
      
      - name: ðŸŽ¨ Setup Node.js pour ESLint
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/frontend/package-lock.json
      
      - name: ðŸ“¦ Installer les dÃ©pendances frontend
        run: |
          cd frontend/frontend
          npm ci
      
      - name: ðŸ” VÃ©rification ESLint SAKA (no-monetary-symbols)
        run: |
          cd frontend/frontend
          echo "ðŸ” =========================================="
          echo "ðŸ” VÃ‰RIFICATION ESLINT SAKA"
          echo "ðŸ” =========================================="
          echo ""
          echo "ðŸ“‹ Objectif : DÃ©tecter les symboles monÃ©taires dans le code frontend"
          echo "ðŸ“‹ RÃ¨gle : egoejo/no-monetary-symbols"
          echo "ðŸ“‹ Symboles interdits : â‚¬, $, USD, EUR, GBP, CHF, JPY, CAD, AUD"
          echo ""
          
          # ExÃ©cuter ESLint avec la rÃ¨gle custom
          # BLOQUANT : Toute violation ESLint SAKA doit faire Ã©chouer le workflow
          # Constitution EGOEJO: Aucune tolÃ©rance pour les symboles monÃ©taires dans le code SAKA
          npm run lint -- --max-warnings 0 --format json --output-file eslint-report.json
          ESLINT_EXIT_CODE=$?
          
          if [ $ESLINT_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ =========================================="
            echo "âŒ VIOLATION ESLINT SAKA DÃ‰TECTÃ‰E"
            echo "âŒ =========================================="
            echo ""
            echo "La rÃ¨gle egoejo/no-monetary-symbols a dÃ©tectÃ© des violations :"
            echo "- Symboles monÃ©taires dans les strings"
            echo "- Symboles monÃ©taires dans les commentaires"
            echo "- Symboles monÃ©taires dans le JSX"
            echo ""
            
            # Afficher les erreurs ESLint
            if [ -f eslint-report.json ]; then
              echo "ðŸ“‹ DÃ©tails des violations :"
              cat eslint-report.json | grep -A 5 "no-monetary-symbols" || true
            fi
            
            echo ""
            echo "Action requise :"
            echo "1. Examiner les erreurs ESLint ci-dessus"
            echo "2. Remplacer les symboles monÃ©taires par formatSakaAmount()"
            echo "3. Relancer ESLint : npm run lint"
            echo "4. Recommiter"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "âœ… VÃ©rification ESLint SAKA : Aucune violation dÃ©tectÃ©e"
          echo ""
      
      - name: ðŸ“Š RÃ©sumÃ© des tests de compliance
        if: always()
        run: |
          cd backend
          echo "## ðŸ“‹ RÃ©sumÃ© des Tests de Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Tests ExÃ©cutÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Tests de Compliance Philosophique** (tag \`@egoejo_compliance\`)" >> $GITHUB_STEP_SUMMARY
          echo "2. **Scan Automatique du Code Python** (scan rÃ©cursif)" >> $GITHUB_STEP_SUMMARY
          echo "3. **Scan des Endpoints API** (routes Django)" >> $GITHUB_STEP_SUMMARY
          echo "4. **VÃ©rification ESLint SAKA** (rÃ¨gle no-monetary-symbols)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š DÃ©tails" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pytest -m egoejo_compliance --collect-only -q 2>&1 | grep "test_" | head -20 >> $GITHUB_STEP_SUMMARY || true
          
          # Ajouter le rÃ©sumÃ© ESLint si disponible
          if [ -f frontend/frontend/eslint-report.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” RÃ©sumÃ© ESLint" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Rapport ESLint disponible dans \`eslint-report.json\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“„ GÃ©nÃ©rer Rapport d'Audit
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Rapport d'Audit EGOEJO Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date** : $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit** : ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branche** : ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Scans EffectuÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Tests de Compliance Philosophique" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Scan Automatique du Code Python" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Scan des Endpoints API" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… VÃ©rification ESLint SAKA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ CritÃ¨res VÃ©rifiÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Conversion SAKA â†” EUR interdite" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Affichage monÃ©taire SAKA interdit" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Accumulation SAKA interdite" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ DÃ©sactivation compostage interdite" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Activation V2.0 sans feature flag interdite" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Endpoints API non conformes interdits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Statut" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **CONFORME EGOEJO** - Tous les scans ont rÃ©ussi" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **NON CONFORME** - Violations dÃ©tectÃ©es" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Ce rapport est gÃ©nÃ©rÃ© automatiquement par le workflow EGOEJO Compliance.*" >> $GITHUB_STEP_SUMMARY
          echo "*Pour plus d'informations, voir [docs/egoejo_compliance/LABEL_EGOEJO_COMPLIANT.md](../../docs/egoejo_compliance/LABEL_EGOEJO_COMPLIANT.md)*" >> $GITHUB_STEP_SUMMARY
