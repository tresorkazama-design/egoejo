name: ðŸ›ï¸ EGOEJO Guardian - PR Bot & Auditeur

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  push:
    branches: [main, develop]

jobs:
  guardian-check:
    runs-on: ubuntu-latest
    name: ðŸ›¡ï¸ Gardien de la Constitution EGOEJO
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # NÃ©cessaire pour git diff
      
      - name: ðŸš« VÃ©rifier Absence de Conversion SAKA â†” EUR
        id: check_conversion
        run: |
          echo "ðŸ” Recherche de violations : Conversion SAKA â†” EUR"
          
          VIOLATIONS=0
          
          # Patterns interdits pour conversion SAKA â†’ EUR
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(convert.*saka.*eur|saka.*to.*eur|eur.*to.*saka|saka.*exchange.*rate|saka.*price|saka.*value.*eur|saka.*worth.*eur)" -- "*.py" "*.js" "*.jsx" "*.ts" "*.tsx"; then
            echo "âŒ VIOLATION CRITIQUE : Conversion SAKA â†” EUR dÃ©tectÃ©e"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Aucune conversion SAKA â†” EUR n'est autorisÃ©e. La structure relationnelle (SAKA) et la structure instrumentale (EUR) sont strictement sÃ©parÃ©es."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # Patterns interdits pour rendement financier sur SAKA
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(saka.*roi|saka.*yield|saka.*interest|saka.*dividend|saka.*return.*investment|saka.*profit)" -- "*.py" "*.js" "*.jsx" "*.ts" "*.tsx"; then
            echo "âŒ VIOLATION CRITIQUE : Rendement financier sur SAKA dÃ©tectÃ©"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Le SAKA ne peut pas gÃ©nÃ©rer de rendement financier. C'est une unitÃ© d'engagement non monÃ©taire."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # Patterns interdits pour Ã©quivalence monÃ©taire SAKA
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(saka.*\*.*rate.*eur|saka.*\*.*[\d.]+.*eur|saka.*equivalent.*eur|saka.*monetary)" -- "*.py" "*.js" "*.jsx" "*.ts" "*.tsx"; then
            echo "âŒ VIOLATION CRITIQUE : Ã‰quivalence monÃ©taire SAKA dÃ©tectÃ©e"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Le SAKA ne peut pas avoir d'Ã©quivalent monÃ©taire. SAKA et EUR sont strictement sÃ©parÃ©s."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "âœ… Aucune violation de conversion SAKA â†” EUR dÃ©tectÃ©e"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "::error::ðŸš« $VIOLATIONS violation(s) de la Constitution EGOEJO dÃ©tectÃ©e(s)"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸš« VÃ©rifier Absence de MÃ©canismes de Rendement Financier
        id: check_financial_return
        run: |
          echo "ðŸ” Recherche de violations : Rendement financier sur SAKA"
          
          VIOLATIONS=0
          
          # VÃ©rifier les fonctions qui pourraient calculer un rendement
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(def.*calculate.*saka.*return|def.*get.*saka.*roi|def.*saka.*yield|def.*saka.*profit)" -- "*.py"; then
            echo "âŒ VIOLATION CRITIQUE : Fonction de rendement financier SAKA dÃ©tectÃ©e"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Aucune fonction ne peut calculer un rendement financier sur le SAKA."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # VÃ©rifier les calculs de taux d'intÃ©rÃªt ou dividendes
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(saka.*interest.*rate|saka.*dividend.*rate|saka.*compounding)" -- "*.py" "*.js" "*.jsx"; then
            echo "âŒ VIOLATION CRITIQUE : Calcul de taux d'intÃ©rÃªt/dividendes SAKA dÃ©tectÃ©"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Le SAKA ne peut pas gÃ©nÃ©rer d'intÃ©rÃªts ou de dividendes."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "âœ… Aucune violation de rendement financier dÃ©tectÃ©e"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "::error::ðŸš« $VIOLATIONS violation(s) de la Constitution EGOEJO dÃ©tectÃ©e(s)"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸš« VÃ©rifier PrioritÃ© Structure Relationnelle (SAKA)
        id: check_saka_priority
        run: |
          echo "ðŸ” VÃ©rification : PrioritÃ© de la structure relationnelle (SAKA)"
          
          VIOLATIONS=0
          
          # VÃ©rifier qu'aucun code ne dÃ©sactive SAKA en faveur d'EUR
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(disable.*saka|saka.*disabled|if.*eur.*then.*disable.*saka)" -- "*.py" "*.js" "*.jsx"; then
            echo "âŒ VIOLATION CRITIQUE : DÃ©sactivation SAKA dÃ©tectÃ©e"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : La structure relationnelle (SAKA) est PRIORITAIRE. Elle ne peut pas Ãªtre dÃ©sactivÃ©e."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # VÃ©rifier qu'aucun code ne subordonne SAKA Ã  EUR
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(if.*eur.*then.*saka|saka.*depends.*on.*eur|eur.*required.*for.*saka)" -- "*.py" "*.js" "*.jsx"; then
            echo "âŒ VIOLATION CRITIQUE : Subordination SAKA Ã  EUR dÃ©tectÃ©e"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : SAKA ne peut pas dÃ©pendre d'EUR. La structure relationnelle est souveraine."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # VÃ©rifier que les feature flags SAKA ne sont pas dÃ©sactivÃ©s
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(ENABLE_SAKA.*=.*False|SAKA_COMPOST_ENABLED.*=.*False|SAKA_SILO_REDIS_ENABLED.*=.*False)" -- "*.py"; then
            echo "âŒ VIOLATION CRITIQUE : Feature flags SAKA dÃ©sactivÃ©s"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Les feature flags SAKA ne peuvent pas Ãªtre dÃ©sactivÃ©s. SAKA est la structure prioritaire."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "âœ… PrioritÃ© de la structure relationnelle (SAKA) respectÃ©e"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "::error::ðŸš« $VIOLATIONS violation(s) de la Constitution EGOEJO dÃ©tectÃ©e(s)"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸš« VÃ©rifier Anti-Accumulation SAKA
        id: check_anti_accumulation
        run: |
          echo "ðŸ” VÃ©rification : Anti-accumulation SAKA"
          
          VIOLATIONS=0
          
          # VÃ©rifier qu'aucun code ne permet l'accumulation infinie
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(saka.*accumulate.*infinite|saka.*no.*limit|saka.*unlimited|disable.*compost|skip.*compost)" -- "*.py" "*.js" "*.jsx"; then
            echo "âŒ VIOLATION CRITIQUE : Accumulation infinie SAKA dÃ©tectÃ©e"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : L'accumulation SAKA est interdite. Le cycle compostage est obligatoire."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # VÃ©rifier qu'aucun code ne dÃ©sactive le compostage
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(compost.*disabled|compost.*skip|bypass.*compost|remove.*compost)" -- "*.py"; then
            echo "âŒ VIOLATION CRITIQUE : DÃ©sactivation compostage dÃ©tectÃ©e"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Le compostage SAKA est NON NÃ‰GOCIABLE. Il ne peut pas Ãªtre dÃ©sactivÃ©."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "âœ… Anti-accumulation SAKA respectÃ©e"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "::error::ðŸš« $VIOLATIONS violation(s) de la Constitution EGOEJO dÃ©tectÃ©e(s)"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸš« VÃ©rifier Cycle SAKA Incompressible
        id: check_saka_cycle
        run: |
          echo "ðŸ” VÃ©rification : Cycle SAKA incompressible"
          
          VIOLATIONS=0
          
          # VÃ©rifier qu'aucun code ne contourne le cycle SAKA
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(skip.*saka.*cycle|bypass.*saka.*cycle|shortcut.*saka.*cycle)" -- "*.py" "*.js" "*.jsx"; then
            echo "âŒ VIOLATION CRITIQUE : Contournement cycle SAKA dÃ©tectÃ©"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Le cycle SAKA (RÃ©colte â†’ Usage â†’ Compost â†’ Silo â†’ Redistribution) est NON NÃ‰GOCIABLE."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # VÃ©rifier que le Silo est toujours alimentÃ© aprÃ¨s compostage
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "(compost.*without.*silo|compost.*skip.*silo)" -- "*.py"; then
            echo "âŒ VIOLATION CRITIQUE : Compostage sans Silo dÃ©tectÃ©"
            echo "::error::ðŸš« VIOLATION CONSTITUTION EGOEJO : Le SAKA compostÃ© DOIT retourner au Silo Commun."
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "âœ… Cycle SAKA incompressible respectÃ©"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "::error::ðŸš« $VIOLATIONS violation(s) de la Constitution EGOEJO dÃ©tectÃ©e(s)"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸ“Š RÃ©sumÃ© des VÃ©rifications
        if: always()
        run: |
          echo "## ðŸ›ï¸ Rapport Guardian EGOEJO" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… VÃ©rifications EffectuÃ©es :" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Absence de conversion SAKA â†” EUR" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Absence de mÃ©canismes de rendement financier" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… PrioritÃ© de la structure relationnelle (SAKA)" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… Anti-accumulation SAKA" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… Cycle SAKA incompressible" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Constitution EGOEJO :" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Structure Relationnelle (SAKA)** : Souveraine, Prioritaire" >> $GITHUB_STEP_SUMMARY
          echo "- **Structure Instrumentale (EUR)** : SubordonnÃ©e, Dormante par dÃ©faut" >> $GITHUB_STEP_SUMMARY
          echo "- **RÃ¨gle Absolue** : Aucune conversion SAKA â†” EUR" >> $GITHUB_STEP_SUMMARY
          echo "- **RÃ¨gle Absolue** : Aucun rendement financier sur SAKA" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸš« Bloquer PR si Violations DÃ©tectÃ©es
        if: failure()
        run: |
          echo "::error::ðŸš« PR BLOQUÃ‰ : Violations de la Constitution EGOEJO dÃ©tectÃ©es"
          echo "::error::Consultez docs/architecture/CONSTITUTION_EGOEJO.md pour plus d'informations"
          exit 1

